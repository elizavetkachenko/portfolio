-- CTE для метрик акаунтів
WITH account_metrics AS (
  SELECT
    s.date,
    sp.country,
    ac.send_interval,
    ac.is_verified,
    ac.is_unsubscribed,
    COUNT(DISTINCT ac.id) AS account_cnt,
    0 as sent_msg,
    0 as open_msg,
    0 as visit_msg
  FROM `DA.account` ac
  JOIN `DA.account_session` acs ON ac.id = acs.account_id
  JOIN `DA.session_params` sp ON acs.ga_session_id = sp.ga_session_id
  JOIN `DA.session` s ON s.ga_session_id = sp.ga_session_id
  GROUP BY s.date, sp.country, ac.send_interval, ac.is_verified, ac.is_unsubscribed
),


-- CTE для emails
email_metrics AS (
  SELECT
    DATE_ADD(s.date, INTERVAL es.sent_date DAY) as date,
    sp.country,
    ac.send_interval,
    ac.is_verified,
    ac.is_unsubscribed,
    0 as account_cnt,
    COUNT(DISTINCT es.id_message) as sent_msg,
    COUNT(DISTINCT eo.id_message) as open_msg,
    COUNT(DISTINCT ev.id_message) as visit_msg
  FROM `DA.email_sent` es
  LEFT JOIN `DA.email_open` eo
  ON es.id_message = eo.id_message
  LEFT JOIN `DA.email_visit` ev
  ON es.id_message = ev.id_message
  JOIN `DA.account` ac ON ac.id = es.id_account
  JOIN `DA.account_session` acs ON ac.id = acs.account_id
  JOIN `DA.session_params` sp ON sp.ga_session_id = acs.ga_session_id
  JOIN `DA.session` s ON s.ga_session_id = sp.ga_session_id
  GROUP BY date, sp.country, ac.send_interval, ac.is_verified, ac.is_unsubscribed
),


-- Об'єднання всіх метрик
union_all_metrics AS (
  SELECT * FROM account_metrics
  UNION ALL
  SELECT * FROM email_metrics
),


-- Групування об'єднаних даних
final_groups AS (
  SELECT
    date,
    country,
    send_interval,
    is_verified,
    is_unsubscribed,
    SUM(account_cnt) as account_cnt,
    SUM(sent_msg) as sent_msg,
    SUM(open_msg) as open_msg,
    SUM(visit_msg) as visit_msg
  FROM union_all_metrics
  GROUP BY date, country, send_interval, is_verified, is_unsubscribed
),


-- Розрахунок загальних сум по країнах та рангів
last_cte AS (
  SELECT *,
    DENSE_RANK() OVER (ORDER BY total_country_account_cnt DESC) as rank_total_country_account_cnt,
    DENSE_RANK() OVER (ORDER BY total_country_sent_cnt DESC) as rank_total_country_sent_cnt
  FROM (
    SELECT *,
      SUM(account_cnt) OVER (PARTITION BY country) as total_country_account_cnt,
      SUM(sent_msg) OVER (PARTITION BY country) as total_country_sent_cnt
    FROM final_groups
  )
)


-- Фінальний SELECT з фільтрацією
SELECT *
FROM last_cte
WHERE rank_total_country_account_cnt <= 10 OR rank_total_country_sent_cnt <= 10
